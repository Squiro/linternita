---
slug: hackeando-mi-universidad
title: hackeando mi universidad
authors: [linternita]
tags: [random]
---

Hoy en d√≠a pod√©s convertirte en hacker muy f√°cilmente, solo ten√©s que
intentarlo.

<!-- truncate -->

## Introducci√≥n

![miel-login](miel-login.png)

MIeL (HONeY en ingl√©s) es una plataforma de la Universidad Nacional de La
Matanza donde los alumnos pueden ingresar y ver contenido relacionado a sus
materias, enviar mensajes a los profesores, participar en foros dejando
comentarios, subir archivos para entregas de trabajos pr√°cticos, entre otras
cosas...

Muchas de las acciones que enumer√© en el anterior p√°rrafo tienen algo en com√∫n:
involucran la _entrada_ de datos por parte de un usuario. Y no solo eso, si no
que la entrada de dichos datos modifica el contenido de la plataforma.

No estoy diciendo nada muy llamativo. La mayor√≠a de las p√°ginas webs hacen eso:
recibir entradas de un usuario y adaptar el contenido adecuadamente. Cuando
ingres√°s a YouTube y seleccion√°s un video, el mismo empieza a reproducirse.
Cuando ingres√°s texto en un campo de b√∫squeda, la p√°gina lo procesa y te
devuelve datos refinados. Cuando le dej√°s un comentario a la chica que te gusta
en Instagram, qued√°s bloqueado.

En resumen: estas p√°ginas son din√°micas, el contenido de las mismas cambia
dependiendo de las entradas de los usuarios. Esto no es malo de por s√≠, pero
puede llegar a ser peligroso. Un usuario podr√≠a subir un archivo que contenga
virus. Podr√≠a ingresar
[un texto espec√≠fico](https://en.wikipedia.org/wiki/SQL_injection) en un campo
de b√∫squeda que produzca que la p√°gina revele informaci√≥n que no deber√≠a. O
podr√≠a dejar un comentario inofensivo a simple vista, pero que ejecuta c√≥digo
malicioso cuando es visto por los dem√°s usuarios.

Esos casos pueden ser evitados y existen distintas t√©cnicas para hacerlo:
validaci√≥n de entradas, sanitizaci√≥n de entradas (controversial), codificaci√≥n
de salidas.

## "Hackeando" MIeL

En algunos casos no hace falta hacer nada. La p√°gina se "hackea" sola.

En el a√±o 2020 alguien hizo un cambio en la p√°gina, provocando que todo el
directorio de archivos del servidor quede expuesto:

![miel-logs-1](miel-logs-1.png)

Un problema de seguridad interesante. Pero queda en segundo plano gracias a
esto:

![miel-logs-2](miel-logs-2.png)

Por alguna raz√≥n el c√≥digo de MIeL creaba y almacenaba un registro de todos los
intentos fallidos de inicios de sesi√≥n. No solo se guardaba el nombre de usuario
que no pudo iniciar sesi√≥n, si no tambi√©n... la **contrase√±a del usuario**, en
texto simple.

No tiene remate.

## """Hackeando""" MIeL

El lector informado seguro se dio cuenta hace rato de la direcci√≥n de este
art√≠culo. Mucho enfoque en las entradas de los usuarios solo puede significar
una cosa: un ataque de inyecci√≥n.

Los ataques de inyecci√≥n explotan vulnerabilidades presentes en una p√°gina web,
permiti√©ndole a un atacante inyectar una entrada maliciosa que luego puede ser
ejecutada por la p√°gina. Quiz√°s el m√°s conocido de estos ataques (y por suerte,
cayendo en la irrelevancia) es
[SQL Injection](https://en.wikipedia.org/wiki/SQL_injection).

Tan solo un a√±o despu√©s del incidente de los logs, me encontraba cursando una
materia llamada Seguridad en Redes. Justamente en esta materia vimos diferentes
tipos de ataques que pueden ser realizados sobre p√°ginas web. Me sent√≠ como un
mono con una navaja y tuve un impulso muy fuerte y repentino que me llev√≥ a
intentar encontrar un ataque que funcionara dentro de MIeL.

### Buscando un punto d√©bil

Como dije antes, la plataforma permite a los usuarios enviarse mensajes o dejar
comentarios en un foro. Tiene la particularidad de soportar texto enriquecido
(rich text, permite agregar cosas como distintas fuentes, colores, o elementos
como im√°genes), y para eso utiliza un editor de texto muy popular llamado
[TinyMCE](https://www.tiny.cloud/).

![miel-tinymce](miel-tinymce.png)

Para esto, lo que hace TinyMCE detr√°s de escena es crear HTML para representar
ese texto:

![html-text-tinymce](html-text-tinymce.png)

El lenguaje HTML permite la ejecuci√≥n de scripts de c√≥digo JavaScript. Y ac√°
estamos lidiando con un editor de texto que genera HTML, el cual luego (de
enviar un comentario) es reflejado en la p√°gina para que los dem√°s usuarios lo
puedan ver.

¬øEntonces puedo agregar c√≥digo JavaScript en el editor de Tiny? ¬øAs√≠ de f√°cil
es?

No. TinyMCE tiene medidas de seguridad para evitar que los usuarios inyecten
c√≥digo JavaScript al utilizar el editor. Aplica t√©cnicas santiizaci√≥n y
neutralizaci√≥n del contenido. El problema es que sanitizar HTML es algo dif√≠cil
de hacer. Y eso hace que esto sea un punto d√©bil.

### Vulnerando TinyMCE

Uno podr√≠a romperse la cabeza intentando encontrar la forma de romper el
sanitizador de Tiny y lograr inyectar c√≥digo JavaScript en el contenido de un
mensaje...

O podr√≠as averiguar qu√© versi√≥n de Tiny est√° ejecutando la p√°gina y despu√©s
buscar
[CVEs](https://es.wikipedia.org/wiki/Common_Vulnerabilities_and_Exposures) que
afecten a esa versi√≥n. Lo bueno de los CVEs es que no solamente informan sobre
una vulnerabilidad, si no que muchas veces contienen pasos para replicarla.

![version-miel-tinymce](version-miel-tinymce.jpg)

MIeL estaba usando la versi√≥n 4.4.3 de Tiny, que ten√≠a 5 a√±os de antiguedad en
ese entonces. Exist√≠a la posibilidad de que alguien haya encontrado una
vulnerabilidad en todos esos a√±os y que la haya reportado.

En efecto, dicha versi√≥n es vulnerable a XSS seg√∫n lo reportado por el
[CVE-2020-12648](https://nvd.nist.gov/vuln/detail/cve-2020-12648). Seg√∫n el
informe, cuando TinyMCE est√° configurado en el modo cl√°sico, la sanitizaci√≥n y
neutralizaci√≥n puede ser evadida utilizando tags HTML anidados y sin
terminaci√≥n. De esta forma, un atacante podr√≠a insertar un tag HTML `img`,
ingresando espec√≠ficamente atributos `src` y `onerror` para producir una
inyecci√≥n de c√≥digo malicioso.

Para poder aprovechar esta vulnerabilidad, el contenido malicioso debe ser
ingresado program√°ticamente en la instancia del editor TinyMCE. Es decir, el
atacante no puede escribir el contenido, sino que debe lograr una asignaci√≥n
directa de dicho contenido en el editor. Existen dos formas de lograr esto:

- TinyMCE puede asignar como contenido del editor una respuesta que reciba desde
  el servidor. Un atacante podr√≠a enviar contenido malicioso al servidor para
  que el mismo sea asignado al editor.
- Mediante JavaScript, se puede asignar contenido al editor haciendo uso de las
  funciones `setContent` e `insertContent`, las cuales son funciones
  pertenencientes a la instancia activa del editor.

### Ejecuci√≥n del exploit

En MIeL, la ejecuci√≥n del exploit pod√≠a realizarse siguiendo estos pasos:

1. Ingresar a una publicaci√≥n de un foro, o a la funcionalidad de env√≠os de
   mensajes.

   ![exploit-1](exploit-1.jpg)

2. Abrir las Herramientas del Desarrollador en el navegador.

3. Si en la consola escribimos ‚Äútiny‚Äù, veremos los objetos e identificadores que
   existen actualmente en la memoria de JavaScript cuyo nombre comienza por
   ‚Äútiny‚Äù. Esto nos es de utilidad, ya que necesitamos acceder a la instancia
   activa del editor.

   ![exploit-2](exploit-2.jpg)

4. En base a la
   [documentaci√≥n de TinyMCE](https://www.tiny.cloud/docs/api/tinymce/tinymce.editor/),
   sabemos la instancia activa del editor es identificada por la propiedad
   ‚ÄúactiveEditor‚Äù. Al escribir esto en la consola, nos devuelve el objeto
   asociado.

   ![exploit-3](exploit-3.jpg)

5. Una vez obtenida la instancia del editor, podemos hacer uso de la funci√≥n
   `setContent` para ingresar el contenido malicioso. Bas√°ndonos
   [en el ejemplo provisto](https://bishopfox.com/blog/tinymce-version-5-2-1-advisory)
   por la consultora Bishop Fox, insertaremos el siguiente string como
   contenido:

   `<iframe><textarea></iframe><img src="" onerror="alert(document.domain)">`

   Para eso, tenemos que ejecutar el siguiente comando en la consola del
   navegador:

   ```javascript
   tinymce.activeEditor.setContent(
     '<iframe><textarea></iframe><img src="" onerror="alert(document.domain)">'
   );
   ```

   ![exploit-4](exploit-4.jpg)

6. El c√≥digo es ejecutado en el navegador ni bien es ingresado en el editor. El
   mismo permanecer√° en el editor y no se ver√° modificado por m√°s que el
   atacante ingrese contenido extra en el editor. Al enviar el mensaje, los
   contenidos no son neutralizados por el servidor, por lo que el c√≥digo
   malicioso permanece intacto. De esta forma, cuando el recipiente abra el
   mensaje, el c√≥digo se ejecutar√° en su navegador.

   ![exploit-5](exploit-5.jpg)

   En la siguiente imagen se puede observar una demostraci√≥n real de la
   ejecuci√≥n del ataque.

   ![exploit-6](exploit-6.jpg)

   Este exploit era posible no solo gracias a la vulnerabilidad presente en el
   editor TinyMCE, sino tambi√©n gracias a la falta de neutralizaci√≥n del
   contenido por parte del servidor.

   ![exploit-7](exploit-7.jpg)

### ¬øQu√© es lo peor que podr√≠a haber pasado?

Muchas cosas. Se podr√≠an haber robado cookies de sesi√≥n de los usuarios. O
redirigirlos a una p√°gina que tenga un login falso de MIeL, para luego capturar
sus credenciales. Si se hubieran obtenido credenciales de un profesor/tutor, se
podr√≠a modificar contenido bibliogr√°fico de las materias, o mejor a√∫n, cambiar
la correcci√≥n de alg√∫n trabajo pr√°ctico o parcial que haya sido evaluado por
MIeL.

## Conclusi√≥n

Est√° bien, lo admito, el t√≠tulo es muy clickbait. No hubo mucho hackeo que
digamos y no estoy escribiendo esto solamente porque mi abogado me dijo que lo
aclare de forma expl√≠cita.

¬øPor qu√© eleg√≠ MIeL? Ni idea. Pint√≥. Rebelarse contra el sistema y esas cosas.

Pero creo que en base a los dos incidentes puedo dar los siguientes consejos:

1. No repitas/reutilices la misma contrase√±a. Alguien podr√≠a crear una p√°gina
   que la almacena en un registro cada vez que hac√©s un intento fallido o hay un
   error.

1. Las CVEs no solo son buenas para saber si hay una vulnerabilidad en un
   software que est√°s utilizando, sino que tambi√©n pueden servir para encontrar
   ejemplos de c√≥mo explotar esa vulnerabilidad.

Eso es todo por ahora. üî¶

## Pr√≥ximamente en este blog

![kindle](kindle.jpg)

Todas las formas de conseguir ebooks que existen (o al menos todas las que yo
conozco) y c√≥mo usar Calibre para enviarlas a tu Kindle.

Y si no ten√©s Kindle, lo lamento mucho, te est√°s perdiendo un mont√≥n.
